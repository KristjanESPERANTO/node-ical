---
name: Release (npm publish + version bump PR)

on:
  release:
    types: [published]

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (release tag)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: npm
          registry-url: https://registry.npmjs.org

      - name: Validate release tag (must be SemVer without leading "v")
        id: ver
        shell: bash
        run: |
          TAG="${{ github.event.release.tag_name }}"

          # Enforce: no leading "v"
          if [[ "$TAG" == v* ]]; then
            echo "Release tag '$TAG' starts with 'v'. Please use tags like '0.25.1' (no leading v)."
            exit 1
          fi

          # Enforce: SemVer-like
          if ! [[ "$TAG" =~ ^[0-9]+\.[0-9]+\.[0-9]+([.-].+)?$ ]]; then
            echo "Release tag '$TAG' does not look like SemVer (expected e.g. 0.25.1)."
            exit 1
          fi

          echo "version=$TAG" >> "$GITHUB_OUTPUT"

      - name: Install dependencies
        run: npm ci

      - name: Ensure package is not private
        shell: bash
        run: |
          node -e '
            const p=require("./package.json");
            if (p.private === true) {
              console.error("package.json has private:true - refusing to publish.");
              process.exit(1);
            }
          '

      - name: Set package version to release version (no git tag)
        run: npm version "${{ steps.ver.outputs.version }}" --no-git-tag-version

      - name: Preflight - show what will be published
        run: |
          node -p "require('./package.json').name + '@' + require('./package.json').version"
          npm pack --dry-run

      - name: Publish to npm (Trusted Publishing / OIDC)
        run: npm publish --access public

      # The release event checks out the tag (detached HEAD).
      # peter-evans/create-pull-request needs a real branch to work from,
      # so we switch to the default branch and re-apply the version bump there.
      # Discard the intermediate package.json changes from the earlier
      # "Set package version" step so that git checkout succeeds.
      - name: Switch to default branch for version bump
        env:
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          git restore package.json package-lock.json
          git checkout "$DEFAULT_BRANCH"
          npm version "${{ steps.ver.outputs.version }}" --no-git-tag-version

      - name: Create PR for version bump back to default branch
        uses: peter-evans/create-pull-request@v8
        with:
          base: ${{ github.event.repository.default_branch }}
          commit-message: "chore(release): ${{ steps.ver.outputs.version }}"
          title: "chore(release): ${{ steps.ver.outputs.version }}"
          body: |
            Automated version bump after GitHub Release `${{ github.event.release.tag_name }}`.

            - Updates package.json (and lockfile if present) to `${{ steps.ver.outputs.version }}`
            - Published to npm via Trusted Publishing (OIDC)
          branch: "chore/release-${{ steps.ver.outputs.version }}"
          delete-branch: true
          labels: release
